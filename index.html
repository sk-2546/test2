<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shubham GPT</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #f4f7f9;
            --sidebar-bg: #ffffff;
            --chat-bg: #ffffff;
            --header-bg: #ffffff;
            --border-color: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --accent-color: #3b82f6;
            --user-message-bg: #3b82f6;
            --user-message-text: #ffffff;
            --bot-message-bg: #f3f4f6;
            --bot-message-text: #111827;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            overflow: hidden;
        }
        .main-layout {
            display: flex;
            height: 100vh;
        }
        #sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 1rem;
            transition: transform 0.3s ease;
        }
        @media (max-width: 768px) {
            #sidebar {
                position: absolute;
                z-index: 40;
                transform: translateX(-100%);
            }
            #sidebar.open {
                transform: translateX(0);
            }
        }
        #chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--chat-bg);
        }
        .header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .chat-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }
        .input-area {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        #userInput {
            background-color: #f9fafb;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            width: 100%;
            resize: none;
        }
        #userInput:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .message-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            word-wrap: break-word;
        }
        .user-message {
            background-color: var(--user-message-bg);
            color: var(--user-message-text);
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }
        .bot-message {
            background-color: var(--bot-message-bg);
            color: var(--bot-message-text);
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }

        /* Login Modal */
        #login-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 100%;
            max-width: 400px;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="main-layout">
        <!-- Sidebar for Chat History -->
        <aside id="sidebar">
            <h1 class="text-2xl font-bold mb-6">Shubham GPT</h1>
            <button id="new-chat-btn" class="w-full text-left p-3 rounded-lg bg-blue-500 text-white font-semibold hover:bg-blue-600 flex items-center gap-2">
                <span class="material-icons">add</span> New Chat
            </button>
            <nav id="chat-history-list" class="mt-6 flex-grow overflow-y-auto"></nav>
        </aside>

        <!-- Main Chat Area -->
        <main id="chat-container">
            <header class="header">
                 <button id="menu-toggle" class="md:hidden">
                    <span class="material-icons">menu</span>
                </button>
                <div id="header-user-info" class="flex items-center gap-4"></div>
            </header>
            <div id="chatHistory" class="chat-area flex flex-col"></div>
            <div id="loadingIndicator" class="hidden text-center p-4">
                <span class="text-gray-500">Shubham GPT is typing...</span>
            </div>
            <div class="input-area">
                <div class="flex items-center gap-4">
                    <textarea id="userInput" rows="1" placeholder="Ask anything..."></textarea>
                    <button id="sendButton" class="p-3 bg-blue-500 text-white rounded-full hover:bg-blue-600 disabled:bg-gray-400">
                        <span class="material-icons">send</span>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-center mb-2">Sign In Required</h2>
            <p class="text-center text-gray-600 mb-6">Please sign in to continue using Shubham GPT.</p>
            
            <div class="border-b border-gray-200 mb-4">
                <nav class="flex -mb-px" id="login-tabs">
                    <button data-tab="google" class="tab-btn w-1/3 py-4 px-1 text-center border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 active">Google</button>
                    <button data-tab="email" class="tab-btn w-1/3 py-4 px-1 text-center border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Email</button>
                    <button data-tab="phone" class="tab-btn w-1/3 py-4 px-1 text-center border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Phone</button>
                </nav>
            </div>

            <!-- Google Login -->
            <div id="google-tab" class="tab-content active">
                 <button id="google-login-btn" class="w-full mt-4 bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-2 hover:bg-gray-50">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                    Sign in with Google
                </button>
            </div>
            
            <!-- Email/Password Login -->
            <div id="email-tab" class="tab-content">
                <input id="email-input" type="email" placeholder="Email" class="w-full p-2 border rounded mb-2">
                <input id="password-input" type="password" placeholder="Password" class="w-full p-2 border rounded mb-4">
                <button id="email-login-btn" class="w-full bg-blue-500 text-white py-2 rounded">Sign In</button>
                <button id="email-signup-btn" class="w-full mt-2 text-sm text-blue-500">Need an account? Sign Up</button>
            </div>

            <!-- Phone Login -->
            <div id="phone-tab" class="tab-content">
                <div id="phone-input-container">
                    <input id="phone-input" type="tel" placeholder="Phone Number" class="w-full p-2 border rounded mb-2">
                    <button id="phone-signin-btn" class="w-full bg-blue-500 text-white py-2 rounded">Send Code</button>
                    <div id="recaptcha-container" class="mt-2"></div>
                </div>
                <div id="code-input-container" class="hidden">
                     <input id="code-input" type="text" placeholder="Verification Code" class="w-full p-2 border rounded mb-2">
                     <button id="code-verify-btn" class="w-full bg-blue-500 text-white py-2 rounded">Verify Code</button>
                </div>
            </div>

        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, EmailAuthProvider, PhoneAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, RecaptchaVerifier, signInWithPhoneNumber, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, collection, query, where, getDocs, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Firebase Config (Replace with your actual config)
        const firebaseConfig = {
             apiKey: "AIzaSyDT9qA2dQnwKQAIDBZaW4MfuQHzguQX6TY",
             authDomain: "subham-gpt.firebaseapp.com",
             projectId: "subham-gpt",
             storageBucket: "subham-gpt.appspot.com",
             messagingSenderId: "447950286722",
             appId: "1:447950286722:web:b8197211d2d5851ee0699b",
             measurementId: "G-3SSC49EL2R"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const headerUserInfo = document.getElementById('header-user-info');
        const loginModal = document.getElementById('login-modal');
        const sendButton = document.getElementById('sendButton');
        const userInput = document.getElementById('userInput');
        const chatHistoryDiv = document.getElementById('chatHistory');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatHistoryList = document.getElementById('chat-history-list');

        let currentUser = null;
        let currentChatId = null;
        let unsubscribeChat = null;
        let messageCount = parseInt(sessionStorage.getItem('messageCount') || '0');

        // --- Authentication State Management ---
        onAuthStateChanged(auth, user => {
            currentUser = user;
            if (user) {
                // User is logged in
                loginModal.classList.add('hidden');
                updateHeader(user);
                newChatBtn.classList.remove('hidden');
                loadUserChats(user.uid);
                startNewChat();
            } else {
                // User is logged out (guest)
                updateHeader(null);
                newChatBtn.classList.add('hidden');
                chatHistoryList.innerHTML = '';
                chatHistoryDiv.innerHTML = '<div class="bot-message message-bubble">Welcome! Ask me up to 2 questions. Please log in for unlimited access.</div>';
                currentChatId = null;
            }
        });

        function updateHeader(user) {
            headerUserInfo.innerHTML = '';
            if (user) {
                const profilePic = document.createElement('img');
                profilePic.src = user.photoURL || `https://ui-avatars.com/api/?name=${user.email || 'User'}&background=random`;
                profilePic.className = "w-10 h-10 rounded-full";
                headerUserInfo.appendChild(profilePic);

                const userName = document.createElement('span');
                userName.textContent = user.displayName || user.email;
                headerUserInfo.appendChild(userName);

                const logoutBtn = document.createElement('button');
                logoutBtn.innerHTML = `<span class="material-icons">logout</span>`;
                logoutBtn.onclick = () => signOut(auth);
                headerUserInfo.appendChild(logoutBtn);
            } else {
                const loginBtn = document.createElement('button');
                loginBtn.textContent = 'Login';
                loginBtn.className = 'px-4 py-2 bg-blue-500 text-white rounded-lg font-semibold';
                loginBtn.onclick = () => loginModal.classList.remove('hidden');
                headerUserInfo.appendChild(loginBtn);
            }
        }
        
        // --- Guest Message Limit Logic ---
        function checkMessageLimit() {
            if (!currentUser) {
                if (messageCount >= 2) {
                    loginModal.classList.remove('hidden');
                    return false;
                }
                messageCount++;
                sessionStorage.setItem('messageCount', messageCount);
            }
            return true;
        }

        // --- Chat Logic ---
        async function handleSendMessage() {
            const prompt = userInput.value.trim();
            if (!prompt) return;

            if (!checkMessageLimit()) return;
            
            userInput.value = '';
            addMessageToChat('user', prompt);
            
            if (currentUser && currentChatId) {
                await addDoc(collection(db, "users", currentUser.uid, "chats", currentChatId, "messages"), {
                    role: 'user',
                    content: prompt,
                    timestamp: new Date()
                });
            }
            
            // In a real app, you would fetch from your LLM here.
             const botResponse = `This is a simulated response to: "${prompt}"`;
             addMessageToChat('bot', botResponse);
             if (currentUser && currentChatId) {
                await addDoc(collection(db, "users", currentUser.uid, "chats", currentChatId, "messages"), {
                    role: 'bot',
                    content: botResponse,
                    timestamp: new Date()
                });
            }
        }
        
        sendButton.addEventListener('click', handleSendMessage);
        userInput.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        });

        function addMessageToChat(sender, message) {
            const messageEl = document.createElement('div');
            messageEl.className = `message-bubble ${sender === 'user' ? 'user-message' : 'bot-message'}`;
            messageEl.textContent = message;
            chatHistoryDiv.appendChild(messageEl);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        }

        // --- Firestore Chat History ---
        newChatBtn.addEventListener('click', startNewChat);

        async function startNewChat() {
            if (!currentUser) return;
            if (unsubscribeChat) unsubscribeChat();

            const newChatRef = await addDoc(collection(db, "users", currentUser.uid, "chats"), {
                title: "New Chat",
                createdAt: new Date()
            });
            loadChat(newChatRef.id);
        }
        
        async function loadUserChats(uid) {
            const q = query(collection(db, "users", uid, "chats"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                chatHistoryList.innerHTML = '';
                snapshot.forEach(doc => {
                    const chatItem = document.createElement('button');
                    chatItem.className = 'w-full text-left p-2 rounded-lg hover:bg-gray-100 truncate';
                    chatItem.textContent = doc.data().title || "Untitled Chat";
                    if(doc.id === currentChatId) {
                        chatItem.classList.add('bg-gray-200');
                    }
                    chatItem.onclick = () => loadChat(doc.id);
                    chatHistoryList.appendChild(chatItem);
                });
            });
        }
        
        function loadChat(chatId) {
            if (!currentUser) return;
            currentChatId = chatId;
            chatHistoryDiv.innerHTML = '';
            
            if (unsubscribeChat) unsubscribeChat();
            
            const messagesQuery = query(collection(db, "users", currentUser.uid, "chats", chatId, "messages"), orderBy("timestamp"));
            unsubscribeChat = onSnapshot(messagesQuery, (snapshot) => {
                chatHistoryDiv.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    addMessageToChat(msg.role, msg.content);
                });
            });

            // Highlight active chat in the list
            Array.from(chatHistoryList.children).forEach(child => {
                 child.classList.toggle('bg-gray-200', child.textContent === document.querySelector(`[data-chat-id='${chatId}']`)?.textContent);
            });
        }
        
        // --- Login Modal Logic ---
        document.getElementById('login-tabs').addEventListener('click', e => {
            if(e.target.classList.contains('tab-btn')) {
                const tab = e.target.dataset.tab;
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active', 'border-blue-500', 'text-blue-600'));
                e.target.classList.add('active', 'border-blue-500', 'text-blue-600');
                
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(`${tab}-tab`).classList.add('active');
            }
        });
        
        // Google Sign In
        document.getElementById('google-login-btn').onclick = () => {
            signInWithPopup(auth, new GoogleAuthProvider()).catch(err => console.error(err));
        };
        
        // Email/Pass Sign In
        document.getElementById('email-login-btn').onclick = () => {
            const email = document.getElementById('email-input').value;
            const pass = document.getElementById('password-input').value;
            signInWithEmailAndPassword(auth, email, pass).catch(err => alert(err.message));
        };
        document.getElementById('email-signup-btn').onclick = () => {
            const email = document.getElementById('email-input').value;
            const pass = document.getElementById('password-input').value;
            createUserWithEmailAndPassword(auth, email, pass).catch(err => alert(err.message));
        };

        // Phone Sign In
        window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 'size': 'invisible' });

        document.getElementById('phone-signin-btn').onclick = () => {
            const phoneNumber = document.getElementById('phone-input').value;
            signInWithPhoneNumber(auth, phoneNumber, window.recaptchaVerifier)
                .then(confirmationResult => {
                    window.confirmationResult = confirmationResult;
                    document.getElementById('phone-input-container').classList.add('hidden');
                    document.getElementById('code-input-container').classList.remove('hidden');
                }).catch(err => {
                    console.error(err);
                    alert("Error sending code. Make sure the number is correct and includes country code (e.g., +1... or +91...).");
                });
        };
        document.getElementById('code-verify-btn').onclick = () => {
            const code = document.getElementById('code-input').value;
            window.confirmationResult.confirm(code).catch(err => alert(err.message));
        };

        // Mobile sidebar toggle
        document.getElementById('menu-toggle').addEventListener('click', () => {
             document.getElementById('sidebar').classList.toggle('open');
        });

    </script>
</body>
</html>

